FROM node:22-slim

# Install basic tools
RUN apt-get update && apt-get install -y \
    curl \
    git \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install ttyd from GitHub releases (not in Debian bookworm repos)
RUN curl -sL https://github.com/tsl0922/ttyd/releases/latest/download/ttyd.x86_64 -o /usr/local/bin/ttyd \
    && chmod +x /usr/local/bin/ttyd

# Install CLI tools (Claude Code + Codex)
RUN npm install -g @anthropic-ai/claude-code @openai/codex

# Install Google Cloud SDK (for gcloud auth application-default login)
RUN curl -sL https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-cli-linux-x86_64.tar.gz | tar -xz -C /opt \
    && /opt/google-cloud-sdk/install.sh --quiet --path-update true \
    && ln -s /opt/google-cloud-sdk/bin/gcloud /usr/local/bin/gcloud

COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

WORKDIR /home/node
USER node

EXPOSE 7681

ENTRYPOINT ["entrypoint.sh"]
